<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Updating EJAM Datasets • EJAM</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Updating EJAM Datasets">
<meta name="description" content="Managing large {arrow} datasets used by EJAM app and package">
<meta property="og:description" content="Managing large {arrow} datasets used by EJAM app and package">
<meta property="og:image" content="https://usepa.github.io/EJAM-open/logo.svg">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">EJAM</a>

    <small class="nav-text text-warning me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">2.32.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Overview for EJAM Users</h6></li>
    <li><a class="dropdown-item" href="../articles/0_whatis.html">What is EJAM?</a></li>
    <li><a class="dropdown-item" href="../articles/0_webapp.html">Accessing the Web App</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>For analysts using R</h6></li>
    <li><a class="dropdown-item" href="../articles/1_installing.html">Installing the EJAM R package</a></li>
    <li><a class="dropdown-item" href="../articles/2_quickstart.html">Quick Start Guide</a></li>
    <li><a class="dropdown-item" href="../articles/3_analyzing.html">Using EJAM for Analysis in R</a></li>
    <li><a class="dropdown-item" href="../articles/testdata.html">Examples of Input/Output Files &amp; Data</a></li>
    <li><a class="dropdown-item" href="../articles/distances.html">Comparing Distances (Choosing a Radius)</a></li>
    <li><a class="dropdown-item" href="../articles/naics.html">NAICS (Industries)</a></li>
    <li><a class="dropdown-item" href="../articles/zipcodes.html">Zipcodes</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>For package/app developers</h6></li>
    <li><a class="dropdown-item" href="../articles/dev_deploy-app.html">Deploying the Web App</a></li>
    <li><a class="dropdown-item" href="../articles/dev_run-shinytests.html">Testing EJAM App with Shinytests</a></li>
    <li><a class="dropdown-item" href="../articles/dev_run-unit-tests.html">Testing EJAM Functions with Unit Tests</a></li>
    <li><a class="dropdown-item" href="../articles/dev_update-datasets.html">Updating EJAM Datasets</a></li>
    <li><a class="dropdown-item" href="../articles/dev_update_documentation.html">Updating Documentation</a></li>
    <li><a class="dropdown-item" href="../articles/dev_update-package.html">Updating the Package as a New Release</a></li>
    <li><a class="dropdown-item" href="../articles/dev_future_plans.html">Future Plans and Ideas for EJAM</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Updating EJAM Datasets</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/USEPA/EJAM-open/blob/HEAD/vignettes/dev_update-datasets.Rmd" class="external-link"><code>vignettes/dev_update-datasets.Rmd</code></a></small>
      <div class="d-none name"><code>dev_update-datasets.Rmd</code></div>
    </div>

    
    
<p>The EJAM package and Shiny app make use of many data objects,
including numerous datasets stored in the package’s /data/ folder as
well as several large tables stored in a separate repository
specifically created for holding those large tables, which contain
information on Census blockgroups, Census block internal points, Census
block population weights, and EPA FRS facilities.</p>
<div class="section level2">
<h2 id="how-to-update-datasets-in-ejam">How to Update Datasets in EJAM<a class="anchor" aria-label="anchor" href="#how-to-update-datasets-in-ejam"></a>
</h2>
<p>The process begins from within the EJAM code repo, using the various
<code>datacreate_*</code> scripts to create updated arrow datasets.
Notes and scripts are consolidated in the /data-raw/ folder, and the
starting point is the overarching set of scripts and comments in the
file called
<em><code>/data-raw/datacreate_0_UPDATE_ALL_DATASETS.R</code></em>.</p>
<p>That file covers not only the large arrow datasets that are stored in
a separate repository, but also many smaller data objects that are
installed along with the package in the /data/ folder. Updating all the
package’s data objects can be complicated because there are many
different data objects of various types and formats and locations.</p>
<p>The various data objects need to be updated at various frequencies –
some only yearly (ACS data) and others when facility IDs and locations
change (as often as possible, as when EPA’s FRS is updated). Some need
to be updated only when the package features/code changes, such as the
important data object called <code>map_headernames</code> and objects
such as <code>names_e</code>.</p>
<p>These data files, code details, and other objects change
ANNUALLY:</p>
<ul>
<li>Scripts that update/create the datasets, in
EJAM/data-raw/datacreate_xyz.R files, including how those scripts assign
version/vintage info via metadata</li>
<li>Version Numbering</li>
<li>metadata about vintage/ version in all datasets like in EJAM/data/
#405 Blockgroup Datasets - See issue Update/ Obtain new EJScreen dataset
annually and clean/modify for EJAM #332 (The block (not block group)
tables might be updated less often and are listed below). Other data
objects (summary info constants, metadata on indicators, etc.) issue
Update map_headernames, Names of Indicators (variables), etc. #333 Test
data (inputs) and examples of outputs See issue update Test data
(inputs) and examples of outputs (every time parameters change &amp;
when outputs returned change) #334 Code and documentation in source
files See issue update (annually as EJAM does) the functions and
documentation in source files #335 Other Documentation See issue update
(annually as EJAM does) README, vignettes, other documentation #336
block datasets, etc. See issue Update block datasets etc. when FIPS or
boundaries change #337 These change possibly each year if EJScreen block
weights &amp; Census fips and/or boundaries change! but certainly at
least every 10 years. For frequently-updated (e.g. weekly) datasets, see
UPDATES - automate frequent updates of the frs and sic and naics
datasets + others #284</li>
</ul>
<p>Again, all of those updates should be done starting from an
understanding of the file called
<code>/data-raw/datacreate_0_UPDATE_ALL_DATASETS.R</code>. That script
includes steps to update metadata and documentation and save new
versions of data in the data folder if appropriate.</p>
<p>The information below focuses on the other type of data objects – the
set of large arrow files that are stored outside the package code
repository.</p>
<div class="section level3">
<h3 id="repository-that-stores-the-large-arrow-files">Repository that stores the large arrow files<a class="anchor" aria-label="anchor" href="#repository-that-stores-the-large-arrow-files"></a>
</h3>
<p>The large mostly-Census-related tables are not installed as part of
the R package in the typical /data/ folder that contains .rda files
lazyloaded by the package. Instead, they are kept in a separate github
repository that we refer to here as the data repository. The current
(either installed or loaded source version) of that repository is
<code>desc::desc(file = system.file("DESCRIPTION", package = "EJAM"))$get("ejam_data_repo")</code></p>
<p><em>IMPORTANT:</em> The name of the <em>data</em> repository (as
distinct from the <em>package code</em> repository) must be recorded/
updated in the EJAM package DESCRIPTION file, so that the package will
know where to look for the data files if the datasets were moved to a
new repository, for examples.</p>
</div>
<div class="section level3">
<h3 id="census-related-arrow-files">Census-related arrow files<a class="anchor" aria-label="anchor" href="#census-related-arrow-files"></a>
</h3>
<p>To store the large files needed by the EJAM package, we use the
Apache arrow file format through the {arrow} R package, with file
extension <code>.arrow</code>. This allows us to work with
larger-than-memory data and store it outside of the EJAM package
itself.</p>
<p>The names of these tables should be listed in a file called
<code>R/arrow_ds_names.R</code> and the global variable called
.arrow_ds_names that is used by functions like
<code><a href="../reference/dataload_dynamic.html">dataload_dynamic()</a></code> and
<code><a href="../reference/dataload_from_local.html">dataload_from_local()</a></code>.</p>
<p>As of mid-2025, there were 11 arrow files used by EJAM:</p>
<ul>
<li>
<code>bgid2fips</code>.arrow: crosswalk of EJAM blockgroup IDs (1-n)
with 12-digit blockgroup FIPS codes</li>
<li>
<code>blockid2fips</code>.arrow: crosswalk of EJAM block IDs (1-n)
with 15-digit block FIPS codes</li>
<li>
<code>blockpoints</code>.arrow: Census block internal points lat-lon
coordinates, EJAM block ID</li>
<li>
<code>blockwts</code>.arrow: Census block population weight as share
of blockgroup population, EJAM block and blockgroup ID</li>
<li>
<code>bgej</code>.arrow: blockgroup-level statistics of EJ
variables</li>
<li>
<code>quaddata</code>.arrow: 3D spherical coordinates of Census
block internal points, with EJAM block ID</li>
</ul>
</div>
<div class="section level3">
<h3 id="frs-related-arrow-files">FRS-related arrow files<a class="anchor" aria-label="anchor" href="#frs-related-arrow-files"></a>
</h3>
<ul>
<li><p><code>frs</code>.arrow: data.table of EPA Facility Registry
Service (FRS) regulated sites</p></li>
<li><p><code>frs_by_naics</code>.arrow: data.table of NAICS industry
code(s) for each EPA-regulated site in Facility Registry
Service</p></li>
<li><p><code>frs_by_sic</code>.arrow: data.table of SIC industry code(s)
for each EPA-regulated site in Facility Registry Service</p></li>
<li><p><code>frs_by_programid.arrow</code>: data.table of Program System
ID code(s) for each EPA-regulated site in the Facility Registry
Service</p></li>
<li><p><code>frs_by_mact</code>.arrow: data.table of MACT NESHAP
subpart(s) that each EPA-regulated site is subject to</p></li>
</ul>
<p>This document outlines how we will operationalize EJAM’s download,
management, and in-app loading of these arrow datasets.</p>
<p>Below is a description of a workable, default operationalization,
followed by options for potential improvements via automation and
processing efficiency.</p>
</div>
</div>
<div class="section level2">
<h2 id="developmentsetup">Development/Setup<a class="anchor" aria-label="anchor" href="#developmentsetup"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>The arrow files are stored in a separate, public, Git-LFS-enabled
GitHub repo (henceforth ‘ejamdata’). The owner/reponame must be
recorded/updated in the DESCRIPTION file field called ejam_data_repo –
that info is used by the package.</p></li>
<li><p>Then, and any time the arrow datasets are updated, we update the
ejamdata release version via the <code>.github/push_to_ejam.yaml</code>
workflow in the ejamdata repo, thereby saving the arrow files with the
release, to be downloaded automatically by EJAM</p></li>
<li>
<p>EJAM’s <code><a href="../reference/download_latest_arrow_data.html">download_latest_arrow_data()</a></code> function does
the following:</p>
<ol style="list-style-type: lower-alpha">
<li>Checks ejamdata repo’s latest release/version.</li>
<li>Checks user’s EJAM package’s ejamdata version, which is stored in
<code>data/ejamdata_version.txt</code>.
<ol style="list-style-type: lower-roman">
<li>If the <code>data/ejamdata_version.txt</code> file doesn’t exist,
e.g. if it’s the first time installing EJAM, it will be created at the
end of the script.</li>
</ol>
</li>
<li>If the versions are different, download the latest arrow from the
latest ejamdata release with <code><a href="https://docs.ropensci.org/piggyback/reference/pb_download.html" class="external-link">piggyback::pb_download()</a></code>. see
how this function works for details:</li>
</ol>
</li>
</ol>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/download_latest_arrow_data.html">download_latest_arrow_data</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>We add a call to this function in the onAttach script (via the
<code><a href="../reference/dataload_dynamic.html">dataload_dynamic()</a></code> function) so it runs and ensures the
latest arrow files are downloaded when user loads EJAM.</li>
</ol>
</div>
<div class="section level2">
<h2 id="how-it-works-for-the-user">How it Works for the User<a class="anchor" aria-label="anchor" href="#how-it-works-for-the-user"></a>
</h2>
<ol style="list-style-type: decimal">
<li>User installs EJAM
<ol style="list-style-type: lower-alpha">
<li>
<code>devtools::install_github("USEPA/EJAM-open")</code> (or as
adjusted depending on the actual repository owner and name)</li>
</ol>
</li>
<li>User loads EJAM as usual
<ol style="list-style-type: lower-alpha">
<li>
<code><a href="https://usepa.github.io/EJAM-open">library(EJAM)</a></code>. This will trigger the new
<code><a href="../reference/download_latest_arrow_data.html">download_latest_arrow_data()</a></code> function.</li>
</ol>
</li>
<li>User runs EJAM as usual
<ol style="list-style-type: lower-alpha">
<li>The <code><a href="../reference/dataload_dynamic.html">dataload_dynamic()</a></code> function will work as usual
because the data are now stored in the <code>data</code> directory.</li>
</ol>
</li>
</ol>
</div>
<div class="section level2">
<h2 id="how-new-versions-of-arrow-datasets-are-republished-released">How new versions of arrow datasets are republished/ released<a class="anchor" aria-label="anchor" href="#how-new-versions-of-arrow-datasets-are-republished-released"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p>The key arrow files are updated from within the EJAM code
repository, as explained above.</p></li>
<li><p>Those files were then being copied into a clone of the ejamdata
repo before being pushed to the actual ejamdata repo on github (at
USEPA/ejamdata)</p></li>
<li><p>This triggers ejamdata’s <code>push_to_ejam.yaml</code> workflow
that increments the latest release tag reflecting the new version and
creates a new release</p></li>
</ol>
</div>
<div class="section level2">
<h2 id="potential-improvements">Potential Improvements<a class="anchor" aria-label="anchor" href="#potential-improvements"></a>
</h2>
<div class="section level3">
<h3 id="making-code-more-arrow-friendly">Making Code more Arrow-Friendly<a class="anchor" aria-label="anchor" href="#making-code-more-arrow-friendly"></a>
</h3>
<p>Problem: loading the data as tibbles/dataframes takes a long time</p>
<p>Solution: We may be able to modify our code to be more arrow
-friendly. This essentially keeps the analysis code as a sort of query,
and only actually loads the results into memory when requested (via
<code>collect()</code>) This dramatically reduces used memory, which
would speed up processing times and avoid potential crashes resulting
from not enough memory. However, this would require a decent lift to
update the code in all places</p>
<p>Pros: processing efficiency, significantly reduced memory usage</p>
<p>Implementation: This has been mostly implemented by the
<code><a href="../reference/dataload_dynamic.html">dataload_dynamic()</a></code> function, which contains a
<code>return_data_table</code> parameter. If <code>FALSE</code>, the
arrow file is loaded as an .arrow dataset, rather than a
tibble/dataframe.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>2025</p>
</div>

<div class="pkgdown-footer-right">
  <p>EJAM Version 2.32.3</p>
</div>

    </footer>
</div>





  </body>
</html>
