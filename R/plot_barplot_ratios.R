
#' Helper - Barplot of ratios of indicators (at a site or all sites overall) to US or State average
#' @rdname ejam2barplot
#' @details
#' Used by and similar to [ejam2barplot()], which is an easier way to do this!
#'   This function requires you to specify single_location = TRUE when
#'   using the row_index param. The [ejam2barplot()] function just uses a sitenumber parameter.
#'
#' This function is more flexible than [plot_barplot_ratios()], which it relies on,
#'   since this lets you specify
#'   whether to use overall results from ejamit()$results_overall
#'   or just one site from ejamit()$results_bysite
#'
#' @param out the list of tables that is the output of ejamit() or a related function
#' @param varnames vector of indicator names that are colnames in out$results_overall or out$results_bysite,
#'   like names_d_ratio_to_state_avg or names_d_subgroups_ratio_to_state_avg,
#'   but not a mix of US and State ratios.
#' @param main title of plot - change this if you want to plot State ratios.
#'  If using state ratios, include the word "State" to have it try to infer what the legend should be
#' @param single_location set to TRUE and provide row_index to view one site,
#'  set to FALSE to view overall results from out$results_overall
#' @param row_index the number of the row to use from out$results_bysite, if single_location = TRUE.
#' @param ... passed to plot_barplot_ratios()
#'
#' @export
#' @keywords internal
#'
plot_barplot_ratios_ez = function(out,
                                  varnames = c(names_d_ratio_to_avg, names_d_subgroups_ratio_to_avg),
                                  main = "Residential Populations at the Analyzed Locations Compared to US Overall",
                                  single_location = FALSE, row_index = NULL, ...) {

  if (!single_location && !is.null(row_index)) {warning("ignoring row_index because single_location=TRUE")}
  if (single_location && is.null(row_index)) {stop("must specify row_index if single_location=TRUE")}
  if (single_location && !is.null(row_index)) {
    ## check if data.table (SHP is data.frame)
    if (is.data.table(out$results_bysite)) {
      data_to_plot <- unlist(out$results_bysite[row_index, varnames, with = FALSE])
    } else {
      data_to_plot <- unlist(out$results_bysite[row_index, varnames])
    }

  } else {
    ## check if data.table (SHP is data.frame)
    if (is.data.table(out$results_overall)) {
      data_to_plot <- unlist(out$results_overall[, varnames, with = FALSE])
    } else {
      data_to_plot <- unlist(out$results_overall[, varnames])
    }

  }

  plot_barplot_ratios(data_to_plot, main = main, ...)
}
############################################################################################# #


#' helper - Barplot of ratios of residential population percentages (or other scores) to averages (or other references)
#' @rdname ejam2barplot
#' @details If the parameter called main has the word "State" in it, then the legend
#'   will refer to "State Average" instead of "US Average" -- You cannot plot both types at the same time,
#'   so the ratio.to.us.d.overall parameter should be either
#'   just ratios to average in US or just ratios to average in State.
#' @param ratio.to.us.d.overall named list of a few ratios to plot, but see [ejam2barplot()]
#'   for an easier way to specify which indicator to show.
#' @param shortlabels optional, names to use for plot - should be same length as named list ratio.to.us.d.overall
#' @param mycolorsavailable optional (best to leave as default)
#' @param main optional, title for plot, like "Analyzed Locations Compared to US Overall",
#'   or if using state ratios, include the word "State" to have it try to infer what the legend should be
#' @param ylab optional, label for y axis
#' @param caption text for a key defining some terms that are abbreviations
#'
#' @seealso  [ejam2ratios()] [ejam2barplot()] [plot_barplot_ratios_ez()] [ejam2excel()]
#' @return ggplot should be returned
#'
#' @export
#'
plot_barplot_ratios <- function(ratio.to.us.d.overall,
                                shortlabels = NULL,
                                mycolorsavailable = c("gray","yellow","orange","red"),
                                main = "Residential Populations at the Analyzed Locations Compared to US Overall",
                                ylab = "Ratio vs. Average",
                                caption = "NH = \"non-Hispanic\"\nNHA = \"non-Hispanic alone, aka single race\"") {

  if (is.null(main) || "" %in% main) {main <- "Residential Populations at the Analyzed Locations Compared to US Overall"}
  ########################################################## #
  # NOTES
  #
  #
  # **SOME GENERAL NOTES, DURING EJAM DEVELOPMENT**
  #
  # For plots in general, see:
  #
  # - <https://echarts4r.john-coene.com/articles/themes.html>
  # - <https://exts.ggplot2.tidyverse.org/gallery>
  #
  #
  # **For BARPLOTS, see/ merge/consolidate:**
  #
  # - output$view1_summary_plot <- renderPlot({v1_summary_plot()}) and v1_summary_plot <- reactive({ })
  #   in EJAM server for Short Report if  bar type
  # - output$summ_display_bar <- renderPlot({  }) contains its own plot code not a reactive
  #   in EJAM server for tab showing barplots in Detailed Results
  # - plot_barplot_ratios() drafted function in EJAM
  #
  #
  # **For BOXPLOTS, see:**
  #
  # - v1_summary_plot <- reactive({ })     and output$view1_summary_plot <- renderPlot({v1_summary_plot()})
  #    - in EJAM server for SHORT report if box type, and
  #    - in EJAM server for LONG report passed as a parameter
  # - plot_boxplot_ratios()
  #    (NOT in EJAM server for Detailed Results interactive views)
  # - ejscreenapi_script() code also relevant?
  # - box/scatter examples in ggplot, <https://r-graph-gallery.com/89-box-and-scatter-plot-with-ggplot2.html>
  # - boxplots in base R, <https://www.r-bloggers.com/2023/09/how-to-reorder-boxplots-in-r-a-comprehensive-guide>
  #
  # **For HISTOGRAMS, see:**
  #
  # - output$summ_display_hist <- renderPlot   in EJAM server for interactive views
  ########################################################## #

  # ratio.to.us.d.overall <-   unlist(  out$results_overall[ , c(..names_d_ratio_to_avg, ..names_d_subgroups_ratio_to_avg )]  )
  # ratio.to.us.d.overall <- ratio.to.us.d()  # reactive already available
  # if (isTRUE(all.equal(names(ratio.to.us.d.overall), c(names_d_ratio_to_avg, names_d_subgroups_ratio_to_avg)))) {
  #
  #
  # }
  if (any(duplicated(gsub("state_avg", "avg", unique(varinfo(names(ratio.to.us.d.overall), info = "varlist")$varlist))))) {
    stop("It looks like some of the ratio indicators are for ratio to US avg and others for State avg - cannot plot both at once")
  }

  if (is.null(shortlabels)) {
    shortlabels <- fixcolnames(names(ratio.to.us.d.overall), oldtype = "r", newtype = "shortlabel")
    shortlabels <- gsub("^Ratio to US avg", "", shortlabels)  # Remove the prefix
    shortlabels <- gsub("^Ratio to State avg", "", shortlabels)  # Remove the prefix
    supershortnames <- gsub(' \\(.*', '', gsub("People of Color", "POC", shortlabels))
    names(ratio.to.us.d.overall) <- supershortnames
  } else {
    names(ratio.to.us.d.overall) <- shortlabels
  }

  if (any(duplicated(names(ratio.to.us.d.overall)))) {
    warning("Some shortlabels are not unique, so they will be made unique by adding a number suffix.")
    names(ratio.to.us.d.overall) <- make.unique(names(ratio.to.us.d.overall), sep = " ")
  }

  ratio.to.us.d.overall[is.infinite(ratio.to.us.d.overall)] <- 0
  # use yellow/orange/red for ratio >= 1x, 2x, 3x  #  work in progress
  mycolors <- mycolorsavailable[1 + findInterval(ratio.to.us.d.overall, c(1.01, 2, 3))]

  # barplot(ratio.to.us.d.overall,
  #         main = 'Ratio vs. US Average for Residential Population Indicators',
  #         cex.names = 0.7,
  #         col = mycolors)
  # abline(h=1, col="gray")

  thisdata <-  data.frame(name = factor(names(ratio.to.us.d.overall),levels = names(ratio.to.us.d.overall)),
                          value = ratio.to.us.d.overall,
                          color =  factor(
                            mycolors,
                            levels = c( "red","orange","yellow","gray") #Set correct order from least to most
                          )) %>%
    ## drop any indicators with Inf or NaNs
    dplyr::filter(is.finite(.data$value))

  thisdata$name <- factor(thisdata$name) # factor(thisdata$name, levels = thisdata$name)

  #Dynamically generate the color legend based on title
  if (isTRUE(getOption("shiny.testmode"))) {
    set.seed(12345)
  }
  if (grepl("State", main, ignore.case = TRUE)) {
    color_labels <- c(
      "red" = "At least 3x State Average",
      "orange" = "2-3x State Average",
      "yellow" = "1-2x State Average",
      "gray" = "Below State Average"
    )
    legendTitle <- "Ratio vs State Average"
  } else {
    color_labels <- c(
      "red" = "At least 3x US Average",
      "orange" = "2-3x US Average",
      "yellow" = "1-2x US Average",
      "gray" = "Below US Average"
    )
    legendTitle <- "Ratio vs US Average"
  }

  thisplot <- thisdata %>%
    ggplot2::ggplot(ggplot2::aes(x = name, y = value, fill = color)) +
    ggplot2::geom_bar(stat = 'identity', show.legend = TRUE) +
    ## Legend for colors of bars
    ggplot2::scale_fill_manual(
      values = setNames(mycolorsavailable, mycolorsavailable),
      labels = color_labels,
      name = legendTitle,
      drop = FALSE
    ) +
    ggplot2::theme_bw() +
    ggplot2::labs(
      x = NULL,
      y = ylab,
      title = main,
      caption = caption
    ) +
    #scale_x_discrete(labels = scales::label_wrap(7)) +    # requires scales package
    #scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
    #scale_x_discrete(guide = guide_axis(n.dodge = 2)) +

    # add horizontal line at ratio = 1
    ggplot2::geom_hline(ggplot2::aes(yintercept = 1)) +

    ggplot2::scale_y_continuous(limits = c(0, NA), expand = ggplot2::expansion(mult = c(0, 0.05), add = c(0, 0))) +
    ggplot2::theme(
      plot.title = ggplot2::element_text(size = 14, hjust = 0.5),
      axis.text.x = ggplot2::element_text(size = 9, angle = 45, hjust = 1, vjust = 1),
      legend.title = ggplot2::element_text(size = 12),
      legend.text = ggplot2::element_text(size = 10),
      legend.position = "bottom"
    )  + ggplot2::guides(fill = ggplot2::guide_legend(nrow = 2)) # was done by ejam2report

  return(thisplot)

  # ggplot2::ggplot(
  #   ratio.to.us.d.overall,
  #   aes(x = indicator, y = value)
  # ) +
  #   geom_boxplot() +
  #   geom_hline(aes(yintercept = 1)) +
  #   labs(x = "",
  #        y = "Ratio of Indicator values for avg. person in selected locations\n vs. US average value",
  #        title = 'Ratio vs. US Average for Residential Population Indicators')
}
